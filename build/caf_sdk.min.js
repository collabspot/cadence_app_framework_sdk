!function(){function require(e,t,n){t||(t=0);var r=require.resolve(e,t),i=require.m[t][r];if(!i)throw new Error('failed to require "'+e+'" from '+n);if(i.c&&(t=i.c,r=i.m,i=require.m[t][i.m],!i))throw new Error('failed to require "'+r+'" from '+t);return i.exports||(i.exports={},i.call(i.exports,i,i.exports,require.relative(r,t))),i.exports}require.resolve=function(e,t){var n=e,r=e+".js",i=e+"/index.js";return require.m[t][r]&&r?r:require.m[t][i]&&i?i:n},require.relative=function(e,t){return function(n){if("."!=n.charAt(0))return require(n,t,e);var r=e.split("/"),i=n.split("/");r.pop();for(var s=0;s<i.length;s++){var o=i[s];".."==o?r.pop():"."!=o&&r.push(o)}return require(r.join("/"),t,e)}},require.m=[],require.m[0]={version:{exports:"2.0.0"},"index.js":function(module,exports,require){var Client=require("client"),Utils=require("utils"),CAFClient={};CAFClient.init=function(callback){var client,params=Utils.queryParameters();return!(!params.origin||!params.app_guid)&&(client=new Client(params.origin,params.app_guid),"function"==typeof callback&&client.on("app.registered",callback.bind(client)),client)},module.exports=CAFClient},"utils.js":function(module,exports,require){function decode(s){return decodeURIComponent((s||"").replace(/\+/g," "))}function queryParameters(queryString){var keyValuePairs,keyAndValue,key,value,result={};if(queryString=queryString||(document.location.search||"").slice(1),0===queryString.length)return result;keyValuePairs=queryString.split("&");for(var i=0;i<keyValuePairs.length;i++)keyAndValue=keyValuePairs[i].split("="),key=decode(keyAndValue[0]),value=decode(keyAndValue[1])||"",result[key]=value;return result}function isPromise(obj){return obj instanceof Promise||!!obj&&obj.then&&"function"==typeof obj.then}function isFalsy(val){return!val||val instanceof Error||"string"==typeof val}function when(items){items=items||[];var resolveAll,rejectAll,allResolvedPromise=new Promise(function(resolve,reject){resolveAll=resolve,rejectAll=reject}),remaining=0,settledWith=[],itemsCopy=Array.isArray(items)?items.slice():[items],resolveWith=function(data,index){settledWith[index]=data,--remaining<=0&&resolveAll(settledWith)};return remaining=itemsCopy.length,remaining<=0?(resolveAll(),allResolvedPromise):(itemsCopy.forEach(function(item,index){var promise;if(isPromise(item))promise=item;else if("function"==typeof item){var res;try{res=item(),promise=isPromise(res)?res:new Promise(function(resolve){resolve(res)})}catch(err){promise=new Promise(function(resolve,reject){reject(err)})}}else promise=new Promise(function(resolve,reject){isFalsy(item)?reject(item):resolve(item)});promise.then(function(data){resolveWith(data,index)})["catch"](rejectAll.bind(rejectAll))}),allResolvedPromise)}var Promise=window.Promise||require("../vendor/native-promise-only");module.exports={queryParameters:queryParameters,when:when}},"client.js":function(module,exports,require){function nextIdFor(name){return isNaN(ids[name])&&(ids[name]=0),++ids[name]}function rawPostMessage(client,msg,forceReady){client.ready||forceReady?client._source.postMessage(msg,client._origin):client.on("app.registered",rawPostMessage.bind(null,client,msg))}function wrappedPostMessage(name,params){var timeoutId,id=nextIdFor("promise"),promise=new Promise(function(resolve,reject){timeoutId=setTimeout(function(){reject(new Error("Invocation request timeout"))},PROMISE_TIMEOUT),pendingPromises[id]={resolve:resolve,reject:reject};var msg=JSON.stringify({id:id,request:name,params:params,appGuid:this._appGuid});rawPostMessage(this,msg)}.bind(this));return promise.then(removePromise.bind(null,id,timeoutId),removePromise.bind(null,id,timeoutId))}function removePromise(id,timeoutId,args){if(clearTimeout(timeoutId),delete pendingPromises[id],args instanceof Error)throw args;return args}function isValidEvent(client,event){return client&&client._origin===event.origin&&client._source===event.source}function messageHandler(client,event){if(isValidEvent(client,event)){var data=event.data;if(data){if("string"==typeof data)try{data=JSON.parse(event.data)}catch(e){return e}var pendingPromise,key,msg;if(data.id&&(pendingPromise=pendingPromises[data.id]))if(data.error){var err=data.error;err.code&&(err=new Error(data.error.msg),err.name=data.error.code,err.stack=data.error.stack),pendingPromise.reject(err)}else pendingPromise.resolve(data.result);else if(CAF_EVENT.test(data.key))if(key=data.key.replace(CAF_EVENT,""),msg={appGuid:client._appGuid},data.needsReply){if(client._repliesPending[key])return;msg.key="iframe.reply:"+key,client._repliesPending[key]=!0,when(client._messageHandlers[key]).then(rawPostMessage.bind(null,client,msg))["catch"](function(reason){msg.error={msg:reason},rawPostMessage(client,msg)}).then(function(){delete client._repliesPending[key]})}else client.trigger(key,data.message);else data.key&&0===data.key.indexOf("invoke:")&&(key=data.key.split(".")[1],client._invokableFunctions[key]&&client._invokableFunctions[key].apply(void 0,data.params).then(function(res){msg=JSON.stringify({key:data.key+".done",result:res,appGuid:client._appGuid}),rawPostMessage(client,msg)}))}}}function ping(){return new Promise(function(resolve){window.setTimeout(function(){resolve("pong")},1e3)})}var PROMISE_TIMEOUT=5e3,CAF_EVENT=/^caf\./,version=require("version"),Promise=window.Promise||require("../vendor/native-promise-only"),when=require("utils").when,pendingPromises={},ids={},Client=function(origin,appGuid){this._origin=origin,this._source=window.parent,this._appGuid=appGuid,this._messageHandlers={},this._invokableFunctions={},this._repliesPending={},this._metadata=null,this._context=null,this.ready=!1,this.on("app.registered",function(data){this.ready=!0,this._metadata=data.metadata,this._context=data.context},this),this.on("context.updated",function(context){this._context=context},this),this.postMessage("iframe.handshake",{version:version}),window.addEventListener("message",messageHandler.bind(null,this)),this.registerFunction("ping",ping)};Client.prototype={postMessage:function(name,data){var msg=JSON.stringify({key:name,message:data,appGuid:this._appGuid});rawPostMessage(this,msg,"iframe.handshake"===name)},on:function(name,handler,context){"function"==typeof handler&&(handler=context?handler.bind(context):handler,this._messageHandlers[name]=this._messageHandlers[name]||[],this._messageHandlers[name].push(handler),"app.registered"!==name&&this.postMessage("iframe.on:"+name))},off:function(name,handler){if(!this._messageHandlers[name])return!1;var index=this._messageHandlers[name].indexOf(handler);return this.postMessage("iframe.off:"+name),this._messageHandlers[name].splice(index,1)[0]},has:function(name,handler){return!!this._messageHandlers[name]&&this._messageHandlers[name].indexOf(handler)!==-1},trigger:function(name,data){return!!this._messageHandlers[name]&&this._messageHandlers[name].map(function(handler){handler(data)})},request:function(options){var requestKey="request:"+nextIdFor("request");return new Promise(function(resolve,reject){"string"==typeof options&&(options={url:options}),this.on(requestKey+".done",function(evt){resolve.apply(this,evt.responseArgs)}),this.on(requestKey+".fail",function(evt){reject.apply(this,evt.responseArgs)}),this.postMessage(requestKey,options)}.bind(this))},registerFunction:function(name,func){this._invokableFunctions[name]=func},metadata:function(){return new Promise(function(resolve){this._metadata?resolve(this._metadata):this.on("app.registered",function(){resolve(this._metadata)}.bind(this))}.bind(this))},context:function(){return new Promise(function(resolve){this._context?resolve(this._context):this.on("app.registered",function(){resolve(this._context)}.bind(this))}.bind(this))},get:function(path){var paths=Array.isArray(path)?path:[path];if(paths.some(function(s){return"string"!=typeof s}))throw new Error("The get method accepts a string or array of strings.");return wrappedPostMessage.call(this,"get",paths)},set:function(key,val){var obj=key;if("string"==typeof key){if(1===arguments.length)throw new Error("The setter requires a value");obj={},obj[key]=val}if("object"!=typeof obj||Array.isArray(obj))throw new Error("The set method accepts 2 string, or an object.");return wrappedPostMessage.call(this,"set",obj)},invoke:function(key){var obj=key;if("string"!=typeof key)throw new Error("Invoke with an object isn't supported.");return obj={},obj[key]=Array.prototype.slice.call(arguments,1),wrappedPostMessage.call(this,"invoke",obj)}},module.exports=Client},"vendor/native-promise-only.js":function(module,exports,require){!function(name,context,definition){context[name]=context[name]||definition(),"undefined"!=typeof module&&module.exports?module.exports=context[name]:"function"==typeof define&&define.amd&&define(function(){return context[name]})}("Promise","undefined"!=typeof global?global:this,function(){"use strict";function schedule(fn,self){scheduling_queue.add(fn,self),cycle||(cycle=timer(scheduling_queue.drain))}function isThenable(o){var _then,o_type=typeof o;return null==o||"object"!=o_type&&"function"!=o_type||(_then=o.then),"function"==typeof _then&&_then}function notify(){for(var i=0;i<this.chain.length;i++)notifyIsolated(this,1===this.state?this.chain[i].success:this.chain[i].failure,this.chain[i]);this.chain.length=0}function notifyIsolated(self,cb,chain){var ret,_then;try{cb===!1?chain.reject(self.msg):(ret=cb===!0?self.msg:cb.call(void 0,self.msg),ret===chain.promise?chain.reject(TypeError("Promise-chain cycle")):(_then=isThenable(ret))?_then.call(ret,chain.resolve,chain.reject):chain.resolve(ret))}catch(err){chain.reject(err)}}function resolve(msg){var _then,self=this;if(!self.triggered){self.triggered=!0,self.def&&(self=self.def);try{(_then=isThenable(msg))?schedule(function(){var def_wrapper=new MakeDefWrapper(self);try{_then.call(msg,function(){resolve.apply(def_wrapper,arguments)},function(){reject.apply(def_wrapper,arguments)})}catch(err){reject.call(def_wrapper,err)}}):(self.msg=msg,self.state=1,self.chain.length>0&&schedule(notify,self))}catch(err){reject.call(new MakeDefWrapper(self),err)}}}function reject(msg){var self=this;self.triggered||(self.triggered=!0,self.def&&(self=self.def),self.msg=msg,self.state=2,self.chain.length>0&&schedule(notify,self))}function iteratePromises(Constructor,arr,resolver,rejecter){for(var idx=0;idx<arr.length;idx++)!function(idx){Constructor.resolve(arr[idx]).then(function(msg){resolver(idx,msg)},rejecter)}(idx)}function MakeDefWrapper(self){this.def=self,this.triggered=!1}function MakeDef(self){this.promise=self,this.state=0,this.triggered=!1,this.chain=[],this.msg=void 0}function Promise(executor){if("function"!=typeof executor)throw TypeError("Not a function");if(0!==this.__NPO__)throw TypeError("Not a promise");this.__NPO__=1;var def=new MakeDef(this);this.then=function(success,failure){var o={success:"function"!=typeof success||success,failure:"function"==typeof failure&&failure};return o.promise=new this.constructor(function(resolve,reject){if("function"!=typeof resolve||"function"!=typeof reject)throw TypeError("Not a function");o.resolve=resolve,o.reject=reject}),def.chain.push(o),0!==def.state&&schedule(notify,def),o.promise},this["catch"]=function(failure){return this.then(void 0,failure)};try{executor.call(void 0,function(msg){resolve.call(def,msg)},function(msg){reject.call(def,msg)})}catch(err){reject.call(def,err)}}var builtInProp,cycle,scheduling_queue,ToString=Object.prototype.toString,timer="undefined"!=typeof setImmediate?function(fn){return setImmediate(fn)}:setTimeout;try{Object.defineProperty({},"x",{}),builtInProp=function(obj,name,val,config){return Object.defineProperty(obj,name,{value:val,writable:!0,configurable:config!==!1})}}catch(err){builtInProp=function(obj,name,val){return obj[name]=val,obj}}scheduling_queue=function(){function Item(fn,self){this.fn=fn,this.self=self,this.next=void 0}var first,last,item;return{add:function(fn,self){item=new Item(fn,self),last?last.next=item:first=item,last=item,item=void 0},drain:function(){var f=first;for(first=last=cycle=void 0;f;)f.fn.call(f.self),f=f.next}}}();var PromisePrototype=builtInProp({},"constructor",Promise,!1);return Promise.prototype=PromisePrototype,builtInProp(PromisePrototype,"__NPO__",0,!1),builtInProp(Promise,"resolve",function(msg){var Constructor=this;return msg&&"object"==typeof msg&&1===msg.__NPO__?msg:new Constructor(function(resolve,reject){if("function"!=typeof resolve||"function"!=typeof reject)throw TypeError("Not a function");resolve(msg)})}),builtInProp(Promise,"reject",function(msg){return new this(function(resolve,reject){if("function"!=typeof resolve||"function"!=typeof reject)throw TypeError("Not a function");reject(msg)})}),builtInProp(Promise,"all",function(arr){var Constructor=this;return"[object Array]"!=ToString.call(arr)?Constructor.reject(TypeError("Not an array")):0===arr.length?Constructor.resolve([]):new Constructor(function(resolve,reject){if("function"!=typeof resolve||"function"!=typeof reject)throw TypeError("Not a function");var len=arr.length,msgs=Array(len),count=0;iteratePromises(Constructor,arr,function(idx,msg){msgs[idx]=msg,++count===len&&resolve(msgs)},reject)})}),builtInProp(Promise,"race",function(arr){var Constructor=this;return"[object Array]"!=ToString.call(arr)?Constructor.reject(TypeError("Not an array")):new Constructor(function(resolve,reject){if("function"!=typeof resolve||"function"!=typeof reject)throw TypeError("Not a function");iteratePromises(Constructor,arr,function(idx,msg){resolve(msg)},reject)})}),Promise})}},CAFClient=require("index.js")}();
//# sourceMappingURL=caf_sdk.min.js.map